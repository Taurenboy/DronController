{"ast":null,"code":"const {\n  KafkaJSRequestTimeoutError,\n  KafkaJSNonRetriableError\n} = require('../../errors');\nconst events = require('../instrumentationEvents');\nconst PRIVATE = {\n  STATE: Symbol('private:SocketRequest:state'),\n  EMIT_EVENT: Symbol('private:SocketRequest:emitEvent')\n};\nconst REQUEST_STATE = {\n  PENDING: Symbol('PENDING'),\n  SENT: Symbol('SENT'),\n  COMPLETED: Symbol('COMPLETED'),\n  REJECTED: Symbol('REJECTED')\n};\n\n/**\n * SocketRequest abstracts the life cycle of a socket request, making it easier to track\n * request durations and to have individual timeouts per request.\n *\n * @typedef {Object} SocketRequest\n * @property {number} createdAt\n * @property {number} sentAt\n * @property {number} pendingDuration\n * @property {number} duration\n * @property {number} requestTimeout\n * @property {string} broker\n * @property {string} clientId\n * @property {RequestEntry} entry\n * @property {boolean} expectResponse\n * @property {Function} send\n * @property {Function} timeout\n *\n * @typedef {Object} RequestEntry\n * @property {string} apiKey\n * @property {string} apiName\n * @property {number} apiVersion\n * @property {number} correlationId\n * @property {Function} resolve\n * @property {Function} reject\n */\nmodule.exports = class SocketRequest {\n  /**\n   * @param {Object} options\n   * @param {number} options.requestTimeout\n   * @param {string} options.broker - e.g: 127.0.0.1:9092\n   * @param {string} options.clientId\n   * @param {RequestEntry} options.entry\n   * @param {boolean} options.expectResponse\n   * @param {Function} options.send\n   * @param {() => void} options.timeout\n   * @param {import(\"../../instrumentation/emitter\")} [options.instrumentationEmitter=null]\n   */\n  constructor({\n    requestTimeout,\n    broker,\n    clientId,\n    entry,\n    expectResponse,\n    send,\n    timeout,\n    instrumentationEmitter = null\n  }) {\n    this.createdAt = Date.now();\n    this.requestTimeout = requestTimeout;\n    this.broker = broker;\n    this.clientId = clientId;\n    this.entry = entry;\n    this.correlationId = entry.correlationId;\n    this.expectResponse = expectResponse;\n    this.sendRequest = send;\n    this.timeoutHandler = timeout;\n    this.sentAt = null;\n    this.duration = null;\n    this.pendingDuration = null;\n    this[PRIVATE.STATE] = REQUEST_STATE.PENDING;\n    this[PRIVATE.EMIT_EVENT] = (eventName, payload) => instrumentationEmitter && instrumentationEmitter.emit(eventName, payload);\n  }\n  send() {\n    this.throwIfInvalidState({\n      accepted: [REQUEST_STATE.PENDING],\n      next: REQUEST_STATE.SENT\n    });\n    this.sendRequest();\n    this.sentAt = Date.now();\n    this.pendingDuration = this.sentAt - this.createdAt;\n    this[PRIVATE.STATE] = REQUEST_STATE.SENT;\n  }\n  timeoutRequest() {\n    const {\n      apiName,\n      apiKey,\n      apiVersion\n    } = this.entry;\n    const requestInfo = `${apiName}(key: ${apiKey}, version: ${apiVersion})`;\n    const eventData = {\n      broker: this.broker,\n      clientId: this.clientId,\n      correlationId: this.correlationId,\n      createdAt: this.createdAt,\n      sentAt: this.sentAt,\n      pendingDuration: this.pendingDuration\n    };\n    this.timeoutHandler();\n    this.rejected(new KafkaJSRequestTimeoutError(`Request ${requestInfo} timed out`, eventData));\n    this[PRIVATE.EMIT_EVENT](events.NETWORK_REQUEST_TIMEOUT, {\n      ...eventData,\n      apiName,\n      apiKey,\n      apiVersion\n    });\n  }\n  completed({\n    size,\n    payload\n  }) {\n    this.throwIfInvalidState({\n      accepted: [REQUEST_STATE.SENT],\n      next: REQUEST_STATE.COMPLETED\n    });\n    const {\n      entry,\n      correlationId,\n      broker,\n      clientId,\n      createdAt,\n      sentAt,\n      pendingDuration\n    } = this;\n    this[PRIVATE.STATE] = REQUEST_STATE.COMPLETED;\n    this.duration = Date.now() - this.sentAt;\n    entry.resolve({\n      correlationId,\n      entry,\n      size,\n      payload\n    });\n    this[PRIVATE.EMIT_EVENT](events.NETWORK_REQUEST, {\n      broker,\n      clientId,\n      correlationId,\n      size,\n      createdAt,\n      sentAt,\n      pendingDuration,\n      duration: this.duration,\n      apiName: entry.apiName,\n      apiKey: entry.apiKey,\n      apiVersion: entry.apiVersion\n    });\n  }\n  rejected(error) {\n    this.throwIfInvalidState({\n      accepted: [REQUEST_STATE.PENDING, REQUEST_STATE.SENT],\n      next: REQUEST_STATE.REJECTED\n    });\n    this[PRIVATE.STATE] = REQUEST_STATE.REJECTED;\n    this.duration = Date.now() - this.sentAt;\n    this.entry.reject(error);\n  }\n\n  /**\n   * @private\n   */\n  throwIfInvalidState({\n    accepted,\n    next\n  }) {\n    if (accepted.includes(this[PRIVATE.STATE])) {\n      return;\n    }\n    const current = this[PRIVATE.STATE].toString();\n    throw new KafkaJSNonRetriableError(`Invalid state, can't transition from ${current} to ${next.toString()}`);\n  }\n};","map":{"version":3,"names":["KafkaJSRequestTimeoutError","KafkaJSNonRetriableError","require","events","PRIVATE","STATE","Symbol","EMIT_EVENT","REQUEST_STATE","PENDING","SENT","COMPLETED","REJECTED","module","exports","SocketRequest","constructor","requestTimeout","broker","clientId","entry","expectResponse","send","timeout","instrumentationEmitter","createdAt","Date","now","correlationId","sendRequest","timeoutHandler","sentAt","duration","pendingDuration","eventName","payload","emit","throwIfInvalidState","accepted","next","timeoutRequest","apiName","apiKey","apiVersion","requestInfo","eventData","rejected","NETWORK_REQUEST_TIMEOUT","completed","size","resolve","NETWORK_REQUEST","error","reject","includes","current","toString"],"sources":["C:/Users/ingev/Documents/Desarrollo/Luna/DronController/AD_UI/node_modules/kafkajs/src/network/requestQueue/socketRequest.js"],"sourcesContent":["const { KafkaJSRequestTimeoutError, KafkaJSNonRetriableError } = require('../../errors')\nconst events = require('../instrumentationEvents')\n\nconst PRIVATE = {\n  STATE: Symbol('private:SocketRequest:state'),\n  EMIT_EVENT: Symbol('private:SocketRequest:emitEvent'),\n}\n\nconst REQUEST_STATE = {\n  PENDING: Symbol('PENDING'),\n  SENT: Symbol('SENT'),\n  COMPLETED: Symbol('COMPLETED'),\n  REJECTED: Symbol('REJECTED'),\n}\n\n/**\n * SocketRequest abstracts the life cycle of a socket request, making it easier to track\n * request durations and to have individual timeouts per request.\n *\n * @typedef {Object} SocketRequest\n * @property {number} createdAt\n * @property {number} sentAt\n * @property {number} pendingDuration\n * @property {number} duration\n * @property {number} requestTimeout\n * @property {string} broker\n * @property {string} clientId\n * @property {RequestEntry} entry\n * @property {boolean} expectResponse\n * @property {Function} send\n * @property {Function} timeout\n *\n * @typedef {Object} RequestEntry\n * @property {string} apiKey\n * @property {string} apiName\n * @property {number} apiVersion\n * @property {number} correlationId\n * @property {Function} resolve\n * @property {Function} reject\n */\nmodule.exports = class SocketRequest {\n  /**\n   * @param {Object} options\n   * @param {number} options.requestTimeout\n   * @param {string} options.broker - e.g: 127.0.0.1:9092\n   * @param {string} options.clientId\n   * @param {RequestEntry} options.entry\n   * @param {boolean} options.expectResponse\n   * @param {Function} options.send\n   * @param {() => void} options.timeout\n   * @param {import(\"../../instrumentation/emitter\")} [options.instrumentationEmitter=null]\n   */\n  constructor({\n    requestTimeout,\n    broker,\n    clientId,\n    entry,\n    expectResponse,\n    send,\n    timeout,\n    instrumentationEmitter = null,\n  }) {\n    this.createdAt = Date.now()\n    this.requestTimeout = requestTimeout\n    this.broker = broker\n    this.clientId = clientId\n    this.entry = entry\n    this.correlationId = entry.correlationId\n    this.expectResponse = expectResponse\n    this.sendRequest = send\n    this.timeoutHandler = timeout\n\n    this.sentAt = null\n    this.duration = null\n    this.pendingDuration = null\n\n    this[PRIVATE.STATE] = REQUEST_STATE.PENDING\n    this[PRIVATE.EMIT_EVENT] = (eventName, payload) =>\n      instrumentationEmitter && instrumentationEmitter.emit(eventName, payload)\n  }\n\n  send() {\n    this.throwIfInvalidState({\n      accepted: [REQUEST_STATE.PENDING],\n      next: REQUEST_STATE.SENT,\n    })\n\n    this.sendRequest()\n    this.sentAt = Date.now()\n    this.pendingDuration = this.sentAt - this.createdAt\n    this[PRIVATE.STATE] = REQUEST_STATE.SENT\n  }\n\n  timeoutRequest() {\n    const { apiName, apiKey, apiVersion } = this.entry\n    const requestInfo = `${apiName}(key: ${apiKey}, version: ${apiVersion})`\n    const eventData = {\n      broker: this.broker,\n      clientId: this.clientId,\n      correlationId: this.correlationId,\n      createdAt: this.createdAt,\n      sentAt: this.sentAt,\n      pendingDuration: this.pendingDuration,\n    }\n\n    this.timeoutHandler()\n    this.rejected(new KafkaJSRequestTimeoutError(`Request ${requestInfo} timed out`, eventData))\n    this[PRIVATE.EMIT_EVENT](events.NETWORK_REQUEST_TIMEOUT, {\n      ...eventData,\n      apiName,\n      apiKey,\n      apiVersion,\n    })\n  }\n\n  completed({ size, payload }) {\n    this.throwIfInvalidState({\n      accepted: [REQUEST_STATE.SENT],\n      next: REQUEST_STATE.COMPLETED,\n    })\n\n    const { entry, correlationId, broker, clientId, createdAt, sentAt, pendingDuration } = this\n\n    this[PRIVATE.STATE] = REQUEST_STATE.COMPLETED\n    this.duration = Date.now() - this.sentAt\n    entry.resolve({ correlationId, entry, size, payload })\n\n    this[PRIVATE.EMIT_EVENT](events.NETWORK_REQUEST, {\n      broker,\n      clientId,\n      correlationId,\n      size,\n      createdAt,\n      sentAt,\n      pendingDuration,\n      duration: this.duration,\n      apiName: entry.apiName,\n      apiKey: entry.apiKey,\n      apiVersion: entry.apiVersion,\n    })\n  }\n\n  rejected(error) {\n    this.throwIfInvalidState({\n      accepted: [REQUEST_STATE.PENDING, REQUEST_STATE.SENT],\n      next: REQUEST_STATE.REJECTED,\n    })\n\n    this[PRIVATE.STATE] = REQUEST_STATE.REJECTED\n    this.duration = Date.now() - this.sentAt\n    this.entry.reject(error)\n  }\n\n  /**\n   * @private\n   */\n  throwIfInvalidState({ accepted, next }) {\n    if (accepted.includes(this[PRIVATE.STATE])) {\n      return\n    }\n\n    const current = this[PRIVATE.STATE].toString()\n\n    throw new KafkaJSNonRetriableError(\n      `Invalid state, can't transition from ${current} to ${next.toString()}`\n    )\n  }\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}